// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PLATFORM_OWNER
  SOCIETY_ADMIN
  RESIDENT
}

enum AccountStatus {
  ACTIVE
  SUSPENDED
}

enum SocietyType {
  APARTMENT
  VILLA
  ROW_HOUSE
}

enum SocietyStatus {
  ACTIVE
  INACTIVE
}

enum UnitType {
  ONE_BHK
  TWO_BHK
  THREE_BHK
  FOUR_BHK
  VILLA
}

enum OwnershipType {
  OWNER
  TENANT
}

enum UnitStatus {
  OCCUPIED
  VACANT
}

enum ResidentType {
  OWNER
  TENANT
}

enum ResidentStatus {
  ACTIVE
  SUSPENDED
}

model User {
  id                String        @id @default(uuid())
  name              String
  email             String        @unique
  passwordHash      String        @map("password_hash")
  role              Role          @default(SOCIETY_ADMIN)
  status            AccountStatus @default(ACTIVE)
  societyId         String?       @map("society_id")
  unitId            String?       @map("unit_id")
  createdBy         String?       @map("created_by")
  lastLoginAt       DateTime?     @map("last_login_at")
  passwordResetToken String?       @map("password_reset_token")
  passwordResetExpires DateTime?   @map("password_reset_expires")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  createdSocieties  Society[]     @relation("SocietyCreator")
  createdUnits      Unit[]        @relation("UnitCreator")
  society           Society?      @relation(fields: [societyId], references: [id])
  unit              Unit?         @relation(fields: [unitId], references: [id])
  raisedIssues      Issue[]
  createdAnnouncements Announcement[]

  @@map("users")
  @@index([societyId])
  @@index([unitId])
}

model Society {
  id                String        @id @default(uuid())
  name              String
  code              String        @unique
  addressLine1      String        @map("address_line1")
  city              String
  state             String
  pincode           String
  societyType       SocietyType   @map("society_type")
  createdBy         String        @map("created_by")
  status            SocietyStatus @default(ACTIVE)
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  creator           User          @relation("SocietyCreator", fields: [createdBy], references: [id])
  units             Unit[]
  residents         User[]
  residentsNew     Resident[]
  maintenance       Maintenance[]
  issues            Issue[]
  announcements     Announcement[]

  @@map("societies")
  @@index([createdBy])
  @@index([code])
}

model Unit {
  id                String        @id @default(uuid())
  societyId         String        @map("society_id")
  buildingName      String        @map("building_name")
  unitNumber        String        @map("unit_number")
  floorNumber       Int?          @map("floor_number")
  unitType          UnitType      @map("unit_type")
  areaSqFt          Float?        @map("area_sq_ft")
  ownershipType     OwnershipType @map("ownership_type")
  status            UnitStatus   @default(OCCUPIED)
  ownerId           String?       @unique @map("owner_id")
  tenantId          String?       @unique @map("tenant_id")
  createdBy         String?       @map("created_by")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  society           Society       @relation(fields: [societyId], references: [id], onDelete: Cascade)
  creator           User?         @relation("UnitCreator", fields: [createdBy], references: [id])
  residents         User[]
  ownerResident     Resident?     @relation("UnitOwner", fields: [ownerId], references: [id])
  tenantResident    Resident?     @relation("UnitTenant", fields: [tenantId], references: [id])
  residentUnits     Resident[]    @relation("ResidentUnit")
  maintenance       Maintenance[]

  @@map("units")
  @@unique([societyId, buildingName, unitNumber])
  @@index([societyId])
  @@index([buildingName])
  @@index([ownerId])
  @@index([tenantId])
}

model Resident {
  id                String          @id @default(uuid())
  societyId         String          @map("society_id")
  buildingId        String?         @map("building_id")
  unitId            String          @map("unit_id")
  residentType      ResidentType    @map("resident_type")
  ownerId           String?         @map("owner_id")
  name              String
  email             String
  mobile            String
  emergencyContact  String?         @map("emergency_contact")
  status            ResidentStatus  @default(ACTIVE)
  startDate         DateTime        @map("start_date")
  endDate           DateTime?       @map("end_date")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  society           Society         @relation(fields: [societyId], references: [id], onDelete: Cascade)
  unit              Unit            @relation("ResidentUnit", fields: [unitId], references: [id], onDelete: Cascade)
  unitAsOwner       Unit?           @relation("UnitOwner")
  unitAsTenant      Unit?           @relation("UnitTenant")
  owner             Resident?       @relation("ResidentOwner", fields: [ownerId], references: [id])
  tenants           Resident[]      @relation("ResidentOwner")

  @@map("residents")
  @@index([societyId])
  @@index([buildingId])
  @@index([unitId])
  @@index([ownerId])
  @@index([email])
  @@index([mobile])
  @@index([status])
}

enum MaintenanceStatus {
  UPCOMING
  DUE
  PAID
  OVERDUE
}

model Maintenance {
  id                String            @id @default(uuid())
  societyId         String            @map("society_id")
  unitId            String            @map("unit_id")
  month             Int               // 1-12
  year              Int               // e.g., 2024
  amount            Float
  dueDate           DateTime          @map("due_date")
  status            MaintenanceStatus @default(UPCOMING)
  paidAt            DateTime?         @map("paid_at")
  paidBy            String?           @map("paid_by")
  notes             String?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  // Relations
  society           Society           @relation(fields: [societyId], references: [id], onDelete: Cascade)
  unit              Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@map("maintenance")
  @@unique([societyId, unitId, month, year])
  @@index([societyId])
  @@index([unitId])
  @@index([status])
  @@index([dueDate])
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Issue {
  id                String          @id @default(uuid())
  societyId         String          @map("society_id")
  unitId            String?         @map("unit_id")
  raisedBy          String          @map("raised_by")
  title             String
  description       String
  status            IssueStatus     @default(OPEN)
  priority          IssuePriority   @default(MEDIUM)
  resolutionNotes   String?         @map("resolution_notes")
  resolvedBy        String?         @map("resolved_by")
  resolvedAt        DateTime?       @map("resolved_at")
  closedAt          DateTime?       @map("closed_at")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  society           Society         @relation(fields: [societyId], references: [id], onDelete: Cascade)
  raiser            User            @relation(fields: [raisedBy], references: [id], onDelete: Cascade)

  @@map("issues")
  @@index([societyId])
  @@index([unitId])
  @@index([raisedBy])
  @@index([status])
  @@index([priority])
}

model Announcement {
  id                String          @id @default(uuid())
  societyId         String          @map("society_id")
  createdBy         String          @map("created_by")
  title             String
  content           String
  isImportant       Boolean         @default(false) @map("is_important")
  expiresAt         DateTime?       @map("expires_at")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  // Relations
  society           Society         @relation(fields: [societyId], references: [id], onDelete: Cascade)
  creator           User            @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("announcements")
  @@index([societyId])
  @@index([createdBy])
  @@index([expiresAt])
}
